import json
import logging
import datetime
import cedar.utils
from jinja2 import Template, Environment


CEDAR_TEMPLATE_ELEMENT_TYPE = "https://schema.metadatacenter.org/core/TemplateElement"

IGNORE_KEYS = [ "@id", "pav:createdOn", "pav:createdOn", "pav:createdBy", "pav:lastUpdatedOn", "oslc:modifiedBy", "title", "description"]

SUB_CONTEXT_TEMPLATE = {}
SUB_CONTEXT_TEMPLATE['properties'] = {}
SUB_CONTEXT_TEMPLATE['properties']["orderNo"] = {}
SUB_CONTEXT_TEMPLATE['properties']["orderNo"]["enum"] = [""]
SUB_CONTEXT_TEMPLATE['properties']["serialNo"] = {}
SUB_CONTEXT_TEMPLATE['properties']["serialNo"]["enum"] = [""]
SUB_CONTEXT_TEMPLATE['properties']["lotNo"] = {}
SUB_CONTEXT_TEMPLATE['properties']["lotNo"]["enum"] = [""]
SUB_CONTEXT_TEMPLATE['properties']["name"] = {}
SUB_CONTEXT_TEMPLATE['properties']["name"]["enum"] = [""]
SUB_CONTEXT_TEMPLATE['additionalProperties'] = False
SUB_CONTEXT_TEMPLATE['type'] = "object"



###TODO provide option to set "@id"  
##TODO add required properties from the schema
##TODO extract the schema:name from the "id" property
##TODO Set _ui input type based on field expected type

cedar_tmpl_element = Template('''
{% set props = ["@context", "@type", "@id" ] %}
{
"$schema": "http://json-schema.org/draft-04/schema#",
"@id": "",
"@type": "{{ CEDAR_TEMPLATE_ELEMENT_TYPE }}",
"@context": {{ CONTEXT_TEMPLATE | tojson }},
"type": "object",
"title": "{{ title }} element schema", 
"description": "{{ title }} element generated by the mircat-tools. ",
"schema:name": "{{ id }}",
"schema:description": "{{ description }}",
"schema:schemaVersion": "1.4.0",
"bibo:status":"bibo:draft",
"pav:version":"0.1",
"_ui": { 
    "order": [ 
    {% for item in properties %}
        {% if not item in props %} "{{ item }}" {% if not loop.last %},{% endif %} {% endif %}       
    {% endfor %} ],
    "propertyLabels": {
    {% for item in properties %} {% if not item in props %}  "{{ item }}" : "{{ item }}"{% if not loop.last %},{% endif %} {% endif %}
    {% endfor %} }
 },
  "pav:createdOn": "{{ DATE  }}",
  "pav:lastUpdatedOn": "{{ DATE  }}",
  "pav:createdBy": "{{ USER_URL }}",
  "oslc:modifiedBy": "{{ USER_URL }}",
  "required": [
    "@context",
    "@id",
    "name"
  ],
  {% set requiredList = required %}
  "properties": {
  "@context": {{ SUB_CONTEXT_TEMPLATE | tojson }},
  "@type": {
          "oneOf": [
            {
              "format": "uri",
              "type": "string"
            },
            {
              "uniqueItems": true,
              "minItems": 1,
              "type": "array",
              "items": {
                "format": "uri",
                "type": "string"
              }
            }
          ]
        },
  "@id":{"format": "uri", "type": ["string", "null"]},
  
  {% for item in properties %}
  
  {% if not item in props %}  
  
  "{{ item }}": {
      "@context": {{ CONTEXT_TEMPLATE | tojson }},
      "title": "{{ item }} field schema",
      "properties": {
        "@type": {
          "oneOf": [
            {
              "format": "uri",
              "type": "string"
            },
            {
              "uniqueItems": true,
              "minItems": 1,
              "type": "array",
              "items": {
                "format": "uri",
                "type": "string"
              }
            }
          ]
        },
        "@value": {
          "type": [
            "string",
            "null"
          ]
        },
        "rdfs:label": {
          "type": [
            "string",
            "null"
          ]
        }
      },
      "schema:description": "{{ item }}",  
      "additionalProperties": false,
      "oslc:modifiedBy": "{{ USER_URL }}",
      "pav:createdOn": "{{ DATE }}",
      "_ui": {
        "inputType": "textfield"
      },
      "description": "{{ item }} field schema autogenerated by {{ MIRCAT }}",
      "pav:lastUpdatedOn": "{{ DATE }}",
      "required": [
        "@value"
      ],
      "@type": "https://schema.metadatacenter.org/core/TemplateField",
      "_valueConstraints": {
        "requiredValue":{% if (requiredList is defined) and (item in requiredList) %} true {% else %} false {% endif%}
      },
      "pav:createdBy": "{{ USER_URL }}",
      "schema:name": "{{ item }}",
      "@id": "TODO",
      "schema:schemaVersion": "1.3.0",
      "type": "object",
      "$schema": "http://json-schema.org/draft-04/schema#"
    }{% if not loop.last %},{% endif %}
  {% endif %} 
  {% endfor %}
  },
 "additionalProperties": {% if additionalProperties %} {{ additionalProperties }} {% else %} false {% endif%} 
}
''')

#logger = logging.getLogger('jsonschema2cedar')
#logger.setLevel(logging.DEBUG)

def convert_template_element(jsonschema_filename):
    try:
        with open(jsonschema_filename, 'r') as orig_schema_file:
            orig_schema = json.load(orig_schema_file)
            cedar_schema = cedar_tmpl_element.render(orig_schema,
                                                     CEDAR_TEMPLATE_ELEMENT_TYPE=CEDAR_TEMPLATE_ELEMENT_TYPE,
                                                     TEMPLATE_CONTEXT=cedar.utils.set_context(),
                                                     DATE="2018-05-30T03:48:41-0700",
                                                     USER_URL="https://metadatacenter.org/users/e856d779-6e24-4d72-a4e6-f7ae4b6419e2",
                                                     MIRCAT="mircat-tools",
                                                     SUB_CONTEXT_TEMPLATE = SUB_CONTEXT_TEMPLATE)
            #logger.debug(cedar_schema)
            return cedar_schema

    except IOError:
        logging.error("Error opening schema file")


def json_pretty_dump(json_object, output_file):
    return json.dump(json_object,  output_file, sort_keys=False, indent=4, separators=(',', ': '))






